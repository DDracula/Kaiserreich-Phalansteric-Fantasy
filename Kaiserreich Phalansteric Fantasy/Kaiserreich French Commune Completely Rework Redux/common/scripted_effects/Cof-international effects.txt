clr_all_flag = {
    clr_country_flag = iri_eu_show
    clr_country_flag = iri_as_show
    clr_country_flag = iri_me_show
    clr_country_flag = iri_af_show
    clr_country_flag = iri_am_show

    clr_tag_flag = yes
    clr_country_flag = phalanstere_show
}

clr_tag_flag = {
    clr_country_flag = iri_euw_show
    clr_country_flag = iri_eum_show
    clr_country_flag = iri_eue_show
    clr_country_flag = iri_eun_show

    clr_country_flag = iri_ase_show
    clr_country_flag = iri_ass_show
    clr_country_flag = iri_asi_show

    clr_country_flag = iri_mei_show
    clr_country_flag = iri_mea_show
    clr_country_flag = iri_meo_show
    clr_country_flag = iri_mee_show

    clr_country_flag = iri_afw_show
    clr_country_flag = iri_afe_show
    clr_country_flag = iri_afm_show
    clr_country_flag = iri_afs_show

    clr_country_flag = iri_amn_show
    clr_country_flag = iri_amm_show
    clr_country_flag = iri_ams_show
}

###     影响力改变
#       set_temp_variable = { iri_euic = 0 }
#       set_temp_variable = { iri_asic = 0 }
#       set_temp_variable = { iri_meic = 0 }
#       set_temp_variable = { iri_afic = 0 }
#       set_temp_variable = { iri_amic = 0 }
#       iri_influence_change = yes
iri_influence_change = {
    if = { limit = { check_variable = { iri_euic = 0 } } }
    else = {
        add_to_variable = { iri_eui = iri_euic }
        custom_effect_tooltip = iri_influence_change_eu
    }

    if = { limit = { check_variable = { iri_asic = 0 } } }
    else = {
        add_to_variable = { iri_asi = iri_asic }
        custom_effect_tooltip = iri_influence_change_as
    }

    if = { limit = { check_variable = { iri_meic = 0 } } }
    else = {
        add_to_variable = { iri_mei = iri_meic }
        custom_effect_tooltip = iri_influence_change_me
    }

    if = { limit = { check_variable = { iri_afic = 0 } } }
    else = {
        add_to_variable = { iri_afi = iri_afic }
        custom_effect_tooltip = iri_influence_change_af
    }

    if = { limit = { check_variable = { iri_amic = 0 } } }
    else = {
        add_to_variable = { iri_ami = iri_amic }
        custom_effect_tooltip = iri_influence_change_am
    }
}

#array_choose
phalanstere_member_list_choose = {
    clear_array = global.phalanstere_totalist
    clear_array = global.phalanstere_syndicalist
    clear_array = global.phalanstere_radical_socialist
    clear_array = global.phalanstere_social_democrat

    every_country = {
        limit = { FRA_is_phalanstere_member = yes }
        if = {
            limit = { has_government = totalist }
            add_to_array = {
				array = global.phalanstere_totalist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = syndicalist }
            add_to_array = {
				array = global.phalanstere_syndicalist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = radical_socialist }
            add_to_array = {
				array = global.phalanstere_radical_socialist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = social_democrat }
            add_to_array = {
				array = global.phalanstere_social_democrat
				value = THIS  
			}
        } 
    }

    clear_array = global.phalanstere_member_list
    every_country = {
        limit = { FRA_is_phalanstere_member = yes }
        
        add_to_array = {
            array = global.phalanstere_member_list
            value = THIS  
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_totalist } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_government = totalist
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_syndicalist } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_government = syndicalist
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_radical_socialist } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_government = radical_socialist
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_social_democrat } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_government = social_democrat
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_agree } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_country_flag = phalanstere_attitude_agree
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_oppose } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_country_flag = phalanstere_attitude_oppose
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }

    if = {
        limit = { FRA = { has_country_flag = phalanstere_member_list_waiver } }
        clear_array = global.phalanstere_member_list
        every_country = {
            limit = { 
                FRA_is_phalanstere_member = yes 
                has_country_flag = phalanstere_attitude_waiver
            }
            add_to_array = {
                array = global.phalanstere_member_list
                value = THIS  
            }
        }
    }
}

clr_vote_all = {
    clr_country_flag = phalanstere_attitude_agree
    remove_from_array = {
        array = global.phalanstere_vote_agree
        value = THIS.id
    }

    clr_country_flag = phalanstere_attitude_oppose
    remove_from_array = {
        array = global.phalanstere_vote_oppose
        value = THIS.id
    }

    clr_country_flag = phalanstere_attitude_waiver
    remove_from_array = {
        array = global.phalanstere_vote_waiver
        value = THIS.id
    }
}

INT_trade_cost_idea_get = {
    hidden_effect = {
        every_country = {
            limit = { FRA_is_phalanstere_member = yes }
            add_ideas = {
                INT_trade_cost_25_tag0
                INT_trade_cost_25_tag1
                INT_trade_cost_25_tag2
                INT_trade_cost_25_tag3
                INT_trade_cost_25_tag4
                INT_trade_cost_25_tag5
                INT_trade_cost_25_tag6
                INT_trade_cost_25_tag7
                INT_trade_cost_25_tag8
                INT_trade_cost_25_tag9
                INT_trade_cost_25_tag10
                INT_trade_cost_25_tag11
                INT_trade_cost_25_tag12
                INT_trade_cost_25_tag13
                INT_trade_cost_25_tag14
                INT_trade_cost_25_tag15
                INT_trade_cost_25_tag16
                INT_trade_cost_25_tag17
                INT_trade_cost_25_tag18
                INT_trade_cost_25_tag19
                INT_trade_cost_25_tag20
                INT_trade_cost_25_tag21
                INT_trade_cost_25_tag22
                INT_trade_cost_25_tag23
                INT_trade_cost_25_tag24
                INT_trade_cost_25_tag25
                INT_trade_cost_25_tag26
                INT_trade_cost_25_tag27
                INT_trade_cost_25_tag28
                INT_trade_cost_25_tag29
                INT_trade_cost_25_tag30
                INT_trade_cost_25_tag31
                INT_trade_cost_25_tag32
                INT_trade_cost_25_tag33
                INT_trade_cost_25_tag34
                INT_trade_cost_25_tag35
                INT_trade_cost_25_tag36
                INT_trade_cost_25_tag37
                INT_trade_cost_25_tag38
                INT_trade_cost_25_tag39
                INT_trade_cost_25_tag40
                INT_trade_cost_25_tag41
                INT_trade_cost_25_tag42
                INT_trade_cost_25_tag43
                INT_trade_cost_25_tag44
                INT_trade_cost_25_tag45
                INT_trade_cost_25_tag46
                INT_trade_cost_25_tag47
                INT_trade_cost_25_tag48
                INT_trade_cost_25_tag49
            }
        }
    }
}

phalanstere_vote_judge_effect = {
    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_inner_circle_of_socialism
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_inner_circle_of_socialism
        set_country_flag = phalanstere_agree_about_inner_circle_of_socialism
    }
    else = { clr_country_flag = phalanstere_discuss_about_inner_circle_of_socialism }

    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_revolutionary_aid_construction
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_revolutionary_aid_construction
        set_country_flag = phalanstere_agree_about_revolutionary_aid_construction
    }
    else = { clr_country_flag = phalanstere_discuss_about_revolutionary_aid_construction }

    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_international_union_of_socialist_students
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_international_union_of_socialist_students
        set_country_flag = phalanstere_agree_about_international_union_of_socialist_students
    }
    else = { clr_country_flag = phalanstere_discuss_about_international_union_of_socialist_students }

    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_abolition_of_bourgeois_jurisdiction
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_abolition_of_bourgeois_jurisdiction
        set_country_flag = phalanstere_agree_about_abolition_of_bourgeois_jurisdiction
    }
    else = { clr_country_flag = phalanstere_discuss_about_abolition_of_bourgeois_jurisdiction }

    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_literacy_expeditionary_force
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_literacy_expeditionary_force
        set_country_flag = phalanstere_agree_about_literacy_expeditionary_force
    }
    else = { clr_country_flag = phalanstere_discuss_about_literacy_expeditionary_force }

    if = {
        limit = { 
            has_country_flag = phalanstere_discuss_about_international_open_laboratory
            check_variable = { global.phalanstere_vote_agree^num > global.phalanstere_vote_oppose^num }
        }
        clr_country_flag = phalanstere_discuss_about_international_open_laboratory
        set_country_flag = phalanstere_agree_about_international_open_laboratory
    }
    else = { clr_country_flag = phalanstere_discuss_about_international_open_laboratory }
}

###     法伦施泰尔团结度改变  
#       set_temp_variable = { phauc = 0 }
#       phalanstere_unity_change = yes
phalanstere_unity_change = {
    if = { limit = { check_variable = { phauc = 0 } } }
    else = {
        add_to_variable = { global.phalanstere_unity = phauc }
        custom_effect_tooltip = phalanstere_unity_change_tt

        clamp_variable = {
            var = global.phalanstere_unity
            max = 100
            min = 0
        }
    }
    phalanstere_buff_judge = yes
}

phalanstere_unity_change_monthly = {
    clear_array = global.phalanstere_totalist
    clear_array = global.phalanstere_syndicalist
    clear_array = global.phalanstere_radical_socialist
    clear_array = global.phalanstere_social_democrat
    every_country = {
        limit = { FRA_is_phalanstere_member = yes }
        if = {
            limit = { has_government = totalist }
            add_to_array = {
				array = global.phalanstere_totalist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = syndicalist }
            add_to_array = {
				array = global.phalanstere_syndicalist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = radical_socialist }
            add_to_array = {
				array = global.phalanstere_radical_socialist
				value = THIS  
			}
        }

        if = {
            limit = { has_government = social_democrat }
            add_to_array = {
				array = global.phalanstere_social_democrat
				value = THIS  
			}
        } 
    }

    set_variable = { phauc_monthly1 = global.phalanstere_member^num }
    multiply_variable = { phauc_monthly1 = 0.1 }
    multiply_variable = { phauc_monthly1 = 5 }

    if = {
        limit = { phalanstere_totalist_advantage = yes }
        set_variable = { phauc_monthly2 = global.phalanstere_syndicalist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_radical_socialist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_social_democrat^num }
        multiply_variable  = { phauc_monthly2 = -0.1 }
    }
    if = {
        limit = { phalanstere_syndicalist_advantage = yes }
        set_variable = { phauc_monthly2 = global.phalanstere_totalist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_radical_socialist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_social_democrat^num }
        multiply_variable  = { phauc_monthly2 = -0.1 }
    }
    if = {
        limit = { phalanstere_radical_socialist_advantage = yes }
        set_variable = { phauc_monthly2 = global.phalanstere_totalist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_radical_socialist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_social_democrat^num }
        multiply_variable  = { phauc_monthly2 = -0.1 }
    }
    if = {
        limit = { phalanstere_social_democrat_advantage = yes }
        set_variable = { phauc_monthly2 = global.phalanstere_totalist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_radical_socialist^num }
        add_to_variable = { phauc_monthly2 = global.phalanstere_social_democrat^num }
        multiply_variable  = { phauc_monthly2 = -0.1 }
    }
    if = {
        limit = {
            phalanstere_totalist_advantage = no
            phalanstere_syndicalist_advantage = no
            phalanstere_radical_socialist_advantage = no
            phalanstere_social_democrat_advantage = no
        }
        set_variable = { phauc_monthly2 = global.phalanstere_member^num }
        multiply_variable  = { phauc_monthly2 = -0.1 }
    }
    multiply_variable = { phauc_monthly2 = 5 }

    set_variable = { phauc_monthly = phauc_monthly1 }
    add_to_variable = { phauc_monthly = phauc_monthly2 }
}

phalanstere_industry_investment_judge = {
    set_temp_variable = { global.piic = 0 }
    every_country = {
        limit = { 
            mio:FRA_phalanstere_reasearch_organization = {  
                OR = {
                    is_mio_trait_completed = mio_phalanstere_industry_investment_factory
                    is_mio_trait_completed = mio_phalanstere_industry_investment_construction
                }
            }
        }
        if = {
            limit = { mio:FRA_phalanstere_reasearch_organization = { is_mio_trait_completed = mio_phalanstere_industry_investment_factory } }
            add_to_temp_variable = { global.piic = 10 }
        }
        if = {
            limit = { mio:FRA_phalanstere_reasearch_organization = { is_mio_trait_completed = mio_phalanstere_industry_investment_construction } }
            add_to_temp_variable = { global.piic = 5 }
        }
    }
    add_to_variable = { global.phalanstere_industry_investment_progress = global.piic }
    while_loop_effect = {
        limit = { check_variable = { global.phalanstere_industry_investment_progress > 99.9 } }
        add_to_variable = { global.phalanstere_industry_investment_num = 1 }
        add_to_variable = { global.phalanstere_industry_investment_progress = -100 }
    }
}

phalanstere_buff_judge = {
    set_temp_variable = { phau = global.phalanstere_unity }
    multiply_temp_variable = { phau = 0.01 }

    set_variable = { INT_political_power_gain = phau }

    set_variable = { INT_political_power_cost = FRA.pha_coop_num }
    multiply_variable = { INT_political_power_cost = 0.05 } 

    if = {
        limit = { FRA = { has_completed_focus = FRA_inner_circle_of_socialism } }
        set_variable = { INT_consumer_goods_factor = -0.1 }
        set_variable = { INT_local_resources_factor = 0.1 }
        set_variable = { INT_trade_cost = -0.25 }
    }
    else = { 
        set_variable = { INT_consumer_goods_factor = 0 } 
        set_variable = { INT_local_resources_factor = 0 }
        set_variable = { INT_trade_cost = 0 }
    }

    if = {
        limit = { FRA = { has_completed_focus = FRA_revolutionary_aid_construction } }
        set_variable = { INT_production_speed_industrial_complex_factor = phau }
        multiply_variable = { INT_production_speed_industrial_complex_factor = 0.1 }

        set_variable = { INT_production_speed_infrastructure_factor = 0.1 }
		set_variable = { INT_production_speed_industrial_complex_factor = 0.05 }
    }
    else = { 
        set_variable = { INT_production_speed_industrial_complex_factor = 0 } 
        set_variable = { INT_production_speed_infrastructure_factor = 0 }
		set_variable = { INT_production_speed_industrial_complex_factor = 0 }
    }
    
    if = {
        limit = { FRA = { has_completed_focus = FRA_international_union_of_socialist_students } }
        add_to_variable = { INT_consumer_goods_factor = -0.05 }
		set_variable = { INT_political_power_factor = 0.1 }

        set_variable = { INT_research_speed_factor = phau }
        multiply_variable = { INT_research_speed_factor = 0.05 }
    }
    else = { 
        set_variable = { INT_political_power_factor = 0 }
        set_variable = { INT_research_speed_factor = 0 }
    }

    if = {
        limit = { FRA = { has_completed_focus = FRA_international_union_of_socialist_students } }
        set_variable = { INT_production_factory_max_efficiency_factor = 0.05 }
		set_variable = { INT_production_factory_start_efficiency_factor = 0.05 }
    }
    else = { 
        set_variable = { INT_production_factory_max_efficiency_factor = 0 }
        set_variable = { INT_production_factory_start_efficiency_factor = 0 }
    }

    if = {
        limit = { FRA = { has_completed_focus = FRA_international_union_of_socialist_students } }
        set_variable = { INT_stability_factor = 0.05 }
		set_variable = { INT_war_support_factor = 0.05 }
		set_variable = { INT_production_factory_efficiency_gain_factor = 0.1 }
    }
    else = { 
        set_variable = { INT_stability_factor = 0 }
        set_variable = { INT_war_support_factor = 0 }
        set_variable = { INT_production_factory_efficiency_gain_factor = 0 }
    }

    set_variable = { INT_research_speed_factor = phau }
    multiply_variable = { INT_research_speed_factor = 0.05 }
    multiply_variable = { INT_research_speed_factor = phatechcoop }

    if = {
        limit = { FRA = { has_completed_focus = FRA_international_open_laboratory } }
        set_variable = { INT_research_sharing_per_country_bonus = 0.5 }
		add_to_variable = { INT_production_factory_max_efficiency_factor = 0.05 }
		add_to_variable = { INT_production_factory_efficiency_gain_factor = 0.05 }
    }
    else = { set_variable = { INT_research_sharing_per_country_bonus = 0 } }

    if = {
        limit = { FRA = { has_completed_focus = FRA_international_open_laboratory } }
        if = {
            limit = { tag = FRA }
            set_variable = { INT_industrial_capacity_factory = 0.15 }
        }
        else = { add_to_variable = { INT_consumer_goods_factor = -0.1 } }
    }
    else = { set_variable = { INT_industrial_capacity_factory = 0 } }

    if = {
        limit = { FRA = { has_completed_focus = FRA_international_open_laboratory } }
        set_variable = { INT_experience_gain_army = 0.03 }
        set_variable = { INT_experience_gain_navy = 0.03 }
        set_variable = { INT_experience_gain_air = 0.03 }
    }
    else = { 
        set_variable = { INT_experience_gain_army = 0 }
        set_variable = { INT_experience_gain_navy = 0 }
        set_variable = { INT_experience_gain_air = 0 }
    }

    if = {
        limit = { mio:FRA_phalanstere_reasearch_organization = { is_mio_trait_completed = mio_phalanstere_industry_investment_factory } }
        set_variable = { INT_civilian_factory_use = 5 }
    }
    else = { set_variable = { INT_civilian_factory_use = 0 } }
    if = {
        limit = { mio:FRA_phalanstere_reasearch_organization = { is_mio_trait_completed = mio_phalanstere_industry_investment_construction } }
        add_to_variable = { INT_production_speed_industrial_complex_factor = -0.1 }
    }

    if = {
        limit = { mio:FRA_phalanstere_reasearch_organization = { is_mio_trait_completed = mio_phalanstere_industry_investment_get_back } }
        set_temp_variable = { t = global.phalanstere_industry_investment_num }
        modulse_temp_varible = { t = 3 }
        set_variable = { INT_industrial_factory_donations = global.phalanstere_industry_investment_num }
        subtract_from_variable = { INT_industrial_factory_donations = t }
        divide_variable = { INT_industrial_factory_donations = 3 }
        if = {
            limit = { check_variable = { t = 1 } }
            add_to_variable = { INT_industrial_factory_donations = 1 }
        }
        set_variable = { INT_military_factory_donations = global.phalanstere_industry_investment_num }
        subtract_from_variable = { INT_military_factory_donations = t }
        divide_variable = { INT_military_factory_donations = 3 }
        if = {
            limit = { check_variable = { t = 2 } }
            add_to_variable = { INT_military_factory_donations = 1 }
        }
        set_variable = { INT_dockyard_donations = global.phalanstere_industry_investment_num }
        subtract_from_variable = { INT_dockyard_donations = t }
        divide_variable = { INT_dockyard_donations = 3 }
    }
    else = {
        set_variable = { INT_industrial_factory_donations = 0 }
        set_variable = { INT_military_factory_donations = 0 }
        set_variable = { INT_dockyard_donations = 0 }
    }
}

#改变立场
phacongress_change_agree_from_waiver = {
    custom_effect_tooltip = phacongress_change_agree_from_waiver
    clr_country_flag = phalanstere_attitude_waiver
    remove_from_array = {
        array = global.phalanstere_vote_waiver
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_agree
    add_to_array = {
        array = global.phalanstere_vote_agree
        value = THIS.id
    }
}

phacongress_change_agree_from_oppose = {
    custom_effect_tooltip = phacongress_change_agree_from_oppose
    clr_country_flag = phalanstere_attitude_oppose
    remove_from_array = {
        array = global.phalanstere_vote_oppose
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_agree
    add_to_array = {
        array = global.phalanstere_vote_agree
        value = THIS.id
    }
}

phacongress_change_oppose_from_waiver = {
    custom_effect_tooltip = phacongress_change_oppose_from_waiver
    clr_country_flag = phalanstere_attitude_waiver
    remove_from_array = {
        array = global.phalanstere_vote_waiver
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_oppose
    add_to_array = {
        array = global.phalanstere_vote_oppose
        value = THIS.id
    }
}

phacongress_change_oppose_from_agree = {
    custom_effect_tooltip = phacongress_change_oppose_from_agree
    clr_country_flag = phalanstere_attitude_agree
    remove_from_array = {
        array = global.phalanstere_vote_agree
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_oppose
    add_to_array = {
        array = global.phalanstere_vote_oppose
        value = THIS.id
    }
}

phacongress_change_waiver_from_agree = {
    custom_effect_tooltip = phacongress_change_waiver_from_agree
    clr_country_flag = phalanstere_attitude_agree
    remove_from_array = {
        array = global.phalanstere_vote_agree
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_waiver
    add_to_array = {
        array = global.phalanstere_vote_waiver
        value = THIS.id
    }
}

phacongress_change_waiver_from_oppose = {
    custom_effect_tooltip = phacongress_change_waiver_from_oppose
    clr_country_flag = phalanstere_attitude_oppose
    remove_from_array = {
        array = global.phalanstere_vote_oppose
        value = THIS.id
    }
    set_country_flag = phalanstere_attitude_waiver
    add_to_array = {
        array = global.phalanstere_vote_waiver
        value = THIS.id
    }
}

#非洲殖民地骚乱
africa_colonial_riot_level_up = {
    if = {
        limit = { has_idea = Cof_africa_colonial_riot4 }
        swap_ideas = {
            remove_idea = Cof_africa_colonial_riot4
            add_idea = Cof_africa_colonial_riot5
        }
    }
    else_if = {
        limit = { has_idea = Cof_africa_colonial_riot3 }
        swap_ideas = {
            remove_idea = Cof_africa_colonial_riot3
            add_idea = Cof_africa_colonial_riot4
        }
    }
    else_if = {
        limit = { has_idea = Cof_africa_colonial_riot2 }
        swap_ideas = {
            remove_idea = Cof_africa_colonial_riot2
            add_idea = Cof_africa_colonial_riot3
        }
    }
    else_if = {
        limit = { has_idea = Cof_africa_colonial_riot1 }
        swap_ideas = {
            remove_idea = Cof_africa_colonial_riot1
            add_idea = Cof_africa_colonial_riot2
        }
    }
    else = { add_ideas = Cof_africa_colonial_riot1 }
}

jap_colonial_riot_judge = {
    clamp_variable = {
        var = jap_colonial_riot_level
        max = 10
        min = 0
    }
    set_variable = { jap_colonial_riot = jap_colonial_riot_level }
    multiply_variable = { jap_colonial_riot = -0.1 }
}

iri_target_gui_get = {
    var:FRA.iri_targeted^0 = {
        set_variable = { FRA.iri_targeted_ideology^1 = THIS.party_popularity_100@syndicalist }
        add_to_variable = { FRA.iri_targeted_ideology^1 = THIS.party_popularity_100@totalist }
        add_to_variable = { FRA.iri_targeted_ideology^1 = THIS.party_popularity_100@radical_socialist }
        set_variable = { FRA.iri_targeted_1 = FRA.iri_targeted_ideology^1 }

        set_variable = { FRA.iri_targeted_ideology^2 = THIS.party_popularity_100@social_democrat }
        add_to_variable = { FRA.iri_targeted_ideology^2 = THIS.party_popularity_100@social_liberal }
        set_variable = { FRA.iri_targeted_2 = FRA.iri_targeted_ideology^2 }  
        add_to_variable = { FRA.iri_targeted_2 = FRA.iri_targeted_1 }

        set_variable = { FRA.iri_targeted_ideology^3 = 100 }
        subtract_from_variable = { FRA.iri_targeted_ideology^3 = FRA.iri_targeted_ideology^1 }
        subtract_from_variable = { FRA.iri_targeted_ideology^3 = FRA.iri_targeted_ideology^2 }  
        
        set_variable = { FRA.iri_targeted_ideology^0 = THIS.stability }
        set_variable = { FRA.iri_targeted_3 = THIS.stability }
        multiply_variable = { FRA.iri_targeted_3 = 50 }
        add_to_variable = { FRA.iri_targeted_3 = 50 }

        every_country_iri_revolution_judge = yes
        set_variable = { FRA.iri_targeted_4 = THIS.cof_iri_revolution }
    }
}

every_country_iri_revolution_judge = {
    set_variable = { cof_iri_revolution = 0 }

    set_temp_variable = { t1 = var:THIS.party_popularity_100@syndicalist }
    add_to_temp_variable = { t1 = var:THIS.party_popularity_100@totalist }
    add_to_temp_variable = { t1 = var:THIS.party_popularity_100@radical_socialist }

    set_temp_variable = { t2 = var:THIS.party_popularity_100@social_democrat }
    add_to_temp_variable = { t2 = var:THIS.party_popularity_100@social_liberal }

    set_temp_variable = { t3 = 100 }
    subtract_from_temp_variable = { t3 = t1 } 
    subtract_from_temp_variable = { t3 = t2 } 

    if = {
        limit = { is_monarchy = yes } 
        set_temp_variable = { d1 = 1 }
        if = {
            limit = { has_country_flag = cof_iri_cooperate_with_republic }
            set_temp_variable = { d2 = 1 }
        }
        else = { set_temp_variable = { d2 = 0.5 } }
        if = {
            limit = {
                OR = {
                    has_government = social_democrat
                    has_government = social_liberal
                }
            }
            add_to_temp_variable = { d2 = -0.2 }
        }
        set_temp_variable = { d3 = -1 }
    }
    else_if = {
        limit = {
            OR = {
                has_government = social_democrat
                has_government = social_liberal
            }
        }
        set_temp_variable = { d1 = 0.8 }
        set_temp_variable = { d2 = -1 }
        set_temp_variable = { d3 = -0.4 }
    }
    else_if = {
        limit = { has_dictatorship_government = yes }
        set_temp_variable = { d1 = 1 }
        if = {
            limit = { has_country_flag = cof_iri_cooperate_with_democrat }
            set_temp_variable = { d2 = 1 }
        }
        else = { set_temp_variable = { d2 = 0.5 } }
        set_temp_variable = { d3 = -1 }
    }
    else = {
        set_temp_variable = { d1 = 1 }
        set_temp_variable = { d2 = -0.4 }
        set_temp_variable = { d3 = -0.4 }
    }

    multiply_temp_variable = { t1 = d1 }
    multiply_temp_variable = { t2 = d2 }
    multiply_temp_variable = { t3 = d3 }

    set_temp_variable = { tp = 0 }
    if = {
        limit = { check_variable = { t1 > 0 } }
        add_to_temp_variable = { tp = t1 }
    }
    if = {
        limit = { check_variable = { t2 > 0 } }
        add_to_temp_variable = { tp = t2 }
    }
    set_temp_variable = { dp = THIS.stability }
    if = {
        limit = { check_variable = { dp > 0.5 } }
        add_to_variable = { cof_iri_revolution = tp }
    }
    else = {
        add_to_temp_variable = { dp = -0.5 }
        multiply_temp_variable = { dp = -4 }
       
        multiply_temp_variable = { tp = dp }
        add_to_variable = { cof_iri_revolution = tp }
    }

    set_temp_variable = { tn = 0 }
    if = {
        limit = { check_variable = { t2 < 0 } }
        add_to_temp_variable = { tn = t2 }
    }
    if = {
        limit = { check_variable = { t3 < 0 } }
        add_to_temp_variable = { tn = t3 }
    }
    set_temp_variable = { dp = THIS.stability }
    if = {
        limit = { check_variable = { dp > 0.5 } }
        add_to_variable = { cof_iri_revolution = tn }
    }
    else = {
        add_to_temp_variable = { dp = -0.5 }
        multiply_temp_variable = { dp = 1.2 }
        add_to_temp_variable = { dp = 1 }

        multiply_temp_variable = { tn = dp }
        add_to_variable = { cof_iri_revolution = tn }
    }

    set_temp_variable = { st = THIS.stability }
    add_to_temp_variable = { st = -0.5 }
    multiply_temp_variable = { st = -80 }
    
    add_to_variable = { cof_iri_revolution = st }

    clamp_variable = { var = cof_iri_revolution max = 100 min = 0 }
    add_to_variable = { cof_iri_revolution = 5 }
    clamp_variable = { var = cof_iri_revolution max = 100 min = 0 }
}

iri_coup_judge = {
    if = {
        limit = { tag = POR }
        POR_remove_monarchy = yes
        hidden_effect = {
			if = {
				limit = { 
					NFA = { exists = yes }
					272 = { is_owned_and_controlled_by = NFA }
				}
				NFA = { country_event = cofintern.171 }
			}
			if = {
				limit = { 
					MAF = { exists = yes }
					881 = { is_owned_and_controlled_by = MAF }
				}
				MAF = { country_event = cofintern.171 }
			}
			if = {
				limit = {
					LEC = { exists = yes }
					326 = { is_owned_and_controlled_by = LEC }
				}
				LEC = { country_event = cofintern.171 }
			}
			else = { 592 = { owner = { country_event = cofintern.171 } } }
            868 = { owner = { country_event = cofintern.171 } }
            1017 = { owner = { country_event = cofintern.171 } }
            news_event = { id = cofintern.172 days = 3 }
        }
    }
}

iri_start_war_jugde_not_socialist = {
    if = {
        limit = { tag = POR }
        create_dynamic_country = {
            original_tag = POR
            create_country_leader = {
                name = POR_jose_carlos_rates
                desc = POR_jose_carlos_rates_leader_desc
                picture = GFX_portrait_POR_jose_carlos_rates_civilian_large
                ideology = totalist_subtype
            }
            create_country_leader = {
                name = POR_manuel_joaquim_sousa
                desc = POR_manuel_joaquim_sousa_leader_desc
                picture = GFX_Portrait_Europe_Generic_new_3
                ideology = syndicalist_subtype
            }
            create_country_leader = {
                name = POR_bento_antonio_goncalves
                desc = POR_bento_antonio_goncalves_leader_desc
                picture = GFX_portrait_POR_bento_antonio_goncalves_civilian_large
                ideology = radical_socialist_subtype
            }
            create_country_leader = {
                name = POR_jose_domingues_dos_santos
                desc = POR_jose_domingues_dos_santos_leader_desc
                picture = GFX_portrait_POR_jose_domingues_dos_santos_civilian_large
                ideology = social_democrat_subtype
            }
            create_country_leader = {
                name = POR_liberato_damiao_ribeiro_pinto
                desc = POR_liberato_damiao_ribeiro_pinto_leader_desc
                picture = GFX_portrait_POR_liberato_damiao_ribeiro_pinto_civilian_large
                ideology = social_liberal_subtype
            }
            create_country_leader = {
                name = POR_antonio_joaquim_granjo
                desc = POR_antonio_joaquim_granjo_leader_desc
                picture = GFX_portrait_POR_antonio_joaquim_granjo_civilian_large
                ideology = market_liberal_subtype
            }
            create_country_leader = {
                name = POR_francisco_pinto_da_cunha_leal
                desc = POR_francisco_pinto_da_cunha_leal_leader_desc
                picture = GFX_portrait_POR_francisco_pinto_da_cunha_leal_civilian_large
                ideology = social_conservative_subtype
            }
            create_country_leader = {
                name = POR_antonio_de_oliveira_salazar
                desc = POR_antonio_de_oliveira_salazar_leader_desc
                picture = GFX_portrait_POR_antonio_de_oliveira_salazar_civilian_large
                ideology = authoritarian_democrat_subtype
            }
            create_country_leader = {
                name = POR_antonio_oscar_de_fragoso_carmona
                desc = POR_antonio_oscar_de_fragoso_carmona_leader_desc
                picture = GFX_portrait_POR_antonio_oscar_de_fragoso_carmona_army_large
                ideology = paternal_autocrat_subtype
            }
            create_country_leader = {
                name = POR_francisco_de_barcelos_rolao_preto
                desc = POR_francisco_de_barcelos_rolao_preto_leader_desc
                picture = GFX_portrait_POR_francisco_de_barcelos_rolao_preto_civilian_large
                ideology = national_populist_subtype
            }
            
            set_stability = 0.6
            set_war_support = 0.5

            set_politics = {
                ruling_party = social_democrat
                elections_allowed = yes
            }
            set_popularities = {
                totalist = 6
                syndicalist = 12
                radical_socialist = 20
                social_democrat = 24
                social_liberal = 17
                market_liberal = 10
                social_conservative = 8
                authoritarian_democrat = 2
                paternal_autocrat = 0
                national_populist = 1
            }

            add_ideas = {
                war_economy
                extensive_conscription
                Cof_new_republic_country
            }

            division_template = {
                name = "Millita"
                template_counter = 68
                role = infantry
                regiments = {
                    militia = { x = 0 y = 0 }
                    militia = { x = 0 y = 1 }
                    militia = { x = 0 y = 2 }
                    militia = { x = 1 y = 0 }
                    militia = { x = 1 y = 1 }
                    militia = { x = 1 y = 2 }
                }
            }

            PREV = {
                set_temp_variable = { t = num_core_states }
                if = {
                    limit = { has_country_flag = cof_iri_revolution_capital_rev }
                    add_to_temp_variable = { t = -1 }
                    capital_scope = { 
                        transfer_state_to = PREV 
                        create_unit = {
                            division = "division_template = \"Millita\" start_experience_factor = 0.8 start_equipment_factor = 1"
                            owner = PREV
                            count = 4
                        }
                    }
                }
                else_if = {
                    limit = { has_country_flag = cof_iri_revolution_capital_gov }
                    add_to_temp_variable = { t = -1 }
                }
                multiply_temp_variable = { t = 0.5 }
                set_temp_variable = { x = 0 }
                while_loop_effect = {
                    limit = { check_variable = { x < t } }
                    random_core_state = {
                        limit = { NOT = { has_state_flag = iri_civil_war_state } }
                        set_state_flag = iri_civil_war_state
                    }
                    add_to_temp_variable = { x = 1 }
                }

                every_core_state = {
                    limit = { has_state_flag = iri_civil_war_state }
                    transfer_state_to = PREV.PREV

                    create_unit = {
                        division = "division_template = \"Millita\" start_experience_factor = 0.8 start_equipment_factor = 1"
                        owner = PREV.PREV
                        count = 4
                    }
                }
            }			

            declare_war_on = {
                target = PREV
                type = annex_everything
            }
            add_civil_war_target = PREV
        }

        if = {
            limit = { 
                country_exists = NFA 
                272 = { is_owned_and_controlled_by = NFA }
            }
            NFA = { country_event = cofintern.171 }
        }
        if = {
            limit = { 
                country_exists = MAF 
                881 = { is_owned_and_controlled_by = MAF }
            }
            MAF = { country_event = cofintern.171 }
        }
        if = {
            limit = {
                country_exists = LEC
                326 = { is_owned_and_controlled_by = LEC }
            }
            LEC = { country_event = cofintern.171 }
        }
        else = { 592 = { owner = { country_event = cofintern.171 } } }
        1017 = { owner = { country_event = cofintern.171 } }

        news_event = { id = cofintern.172 days = 3 }
    }
}

iri_start_war_jugde_socialist = {
    if = {
        limit = { tag = POR }
        create_dynamic_country = {
            original_tag = POR
            create_country_leader = {
                name = POR_jose_carlos_rates
                desc = POR_jose_carlos_rates_leader_desc
                picture = GFX_portrait_POR_jose_carlos_rates_civilian_large
                ideology = totalist_subtype
            }
            create_country_leader = {
                name = POR_manuel_joaquim_sousa
                desc = POR_manuel_joaquim_sousa_leader_desc
                picture = GFX_Portrait_Europe_Generic_new_3
                ideology = syndicalist_subtype
            }
            create_country_leader = {
                name = POR_bento_antonio_goncalves
                desc = POR_bento_antonio_goncalves_leader_desc
                picture = GFX_portrait_POR_bento_antonio_goncalves_civilian_large
                ideology = radical_socialist_subtype
            }
            create_country_leader = {
                name = POR_jose_domingues_dos_santos
                desc = POR_jose_domingues_dos_santos_leader_desc
                picture = GFX_portrait_POR_jose_domingues_dos_santos_civilian_large
                ideology = social_democrat_subtype
            }
            create_country_leader = {
                name = POR_liberato_damiao_ribeiro_pinto
                desc = POR_liberato_damiao_ribeiro_pinto_leader_desc
                picture = GFX_portrait_POR_liberato_damiao_ribeiro_pinto_civilian_large
                ideology = social_liberal_subtype
            }
            create_country_leader = {
                name = POR_antonio_joaquim_granjo
                desc = POR_antonio_joaquim_granjo_leader_desc
                picture = GFX_portrait_POR_antonio_joaquim_granjo_civilian_large
                ideology = market_liberal_subtype
            }
            create_country_leader = {
                name = POR_francisco_pinto_da_cunha_leal
                desc = POR_francisco_pinto_da_cunha_leal_leader_desc
                picture = GFX_portrait_POR_francisco_pinto_da_cunha_leal_civilian_large
                ideology = social_conservative_subtype
            }
            create_country_leader = {
                name = POR_antonio_de_oliveira_salazar
                desc = POR_antonio_de_oliveira_salazar_leader_desc
                picture = GFX_portrait_POR_antonio_de_oliveira_salazar_civilian_large
                ideology = authoritarian_democrat_subtype
            }
            create_country_leader = {
                name = POR_antonio_oscar_de_fragoso_carmona
                desc = POR_antonio_oscar_de_fragoso_carmona_leader_desc
                picture = GFX_portrait_POR_antonio_oscar_de_fragoso_carmona_army_large
                ideology = paternal_autocrat_subtype
            }
            create_country_leader = {
                name = POR_francisco_de_barcelos_rolao_preto
                desc = POR_francisco_de_barcelos_rolao_preto_leader_desc
                picture = GFX_portrait_POR_francisco_de_barcelos_rolao_preto_civilian_large
                ideology = national_populist_subtype
            }
            
            set_stability = 0.6
            set_war_support = 0.5

            set_politics = {
                ruling_party = syndicalist
                elections_allowed = no
            }
            set_popularities = {
                totalist = 12
                syndicalist = 30
                radical_socialist = 24
                social_democrat = 15
                social_liberal = 12
                market_liberal = 2
                social_conservative = 1
                authoritarian_democrat = 2
                paternal_autocrat = 0
                national_populist = 2
            }

            add_ideas = {
                war_economy
                extensive_conscription
                Cof_new_socialist_country
            }
            
            division_template = {
                name = "Millita"
                template_counter = 68
                role = infantry
                regiments = {
                    militia = { x = 0 y = 0 }
                    militia = { x = 0 y = 1 }
                    militia = { x = 0 y = 2 }
                    militia = { x = 1 y = 0 }
                    militia = { x = 1 y = 1 }
                    militia = { x = 1 y = 2 }
                }
            }
            
            PREV = {
                set_temp_variable = { t = num_core_states }
                if = {
                    limit = { has_country_flag = cof_iri_revolution_capital_rev }
                    add_to_temp_variable = { t = -1 }
                    capital_scope = { 
                        transfer_state_to = PREV 
                        create_unit = {
                            division = "division_template = \"Millita\" start_experience_factor = 0.8 start_equipment_factor = 1"
                            owner = PREV
                            count = 4
                        }
                    }
                }
                else_if = {
                    limit = { has_country_flag = cof_iri_revolution_capital_gov }
                    add_to_temp_variable = { t = -1 }
                }
                multiply_temp_variable = { t = 0.5 }
                set_temp_variable = { x = 0 }
                while_loop_effect = {
                    limit = { check_variable = { x < t } }
                    random_core_state = {
                        limit = { NOT = { has_state_flag = iri_civil_war_state } }
                        set_state_flag = iri_civil_war_state
                    }
                    add_to_temp_variable = { x = 1 }
                }

                every_core_state = {
                    limit = { has_state_flag = iri_civil_war_state }
                    transfer_state_to = PREV.PREV

                    create_unit = {
                        division = "division_template = \"Millita\" start_experience_factor = 0.8 start_equipment_factor = 1"
                        owner = PREV.PREV
                        count = 4
                    }
                    clr_state_flag = iri_civil_war_state
                }
            }		
            
            declare_war_on = {
                target = PREV
                type = annex_everything
            }
            add_civil_war_target = PREV
        }

        if = {
            limit = { 
                country_exists = NFA 
                272 = { is_owned_and_controlled_by = NFA }
            }
            NFA = { country_event = cofintern.171 }
        }
        if = {
            limit = { 
                country_exists = MAF 
                881 = { is_owned_and_controlled_by = MAF }
            }
            MAF = { country_event = cofintern.171 }
        }
        if = {
            limit = {
                country_exists = LEC
                326 = { is_owned_and_controlled_by = LEC }
            }
            LEC = { country_event = cofintern.171 }
        }
        else = { 592 = { owner = { country_event = cofintern.171 } } }
        1017 = { owner = { country_event = cofintern.171 } }

        news_event = { id = cofintern.172 days = 3 }
    }
}

activate_countermeasures_decision = {
    if = { limit = { has_country_flag = COF_IRI_HAD } }
    else = { set_country_flag = COF_IRI_HAD }
}

ireland_violend_revolution_army_change = {
    if = { limit = { check_variable = { t = 0 } } }
    else = {
        add_to_variable = {
            iri_ire_revolution_army = t
            tooltip = iri_ire_revolution_army_change
        }
    }
    clamp_variable = {
        var = iri_ire_revolution_army
        min = 0
        max = 10
    }
    if = {
        limit = { check_variable = { iri_ire_revolution_army = 0 } }
        hidden_effect = {
            FRA = { country_event = cofintern.180 }
            ENG = { country_event = cofintern.180 }
            IRE = { country_event = cofintern.180 }
        }
    }
}

cof_count_num_of_volunteers = {
    set_variable = { FRA.num_of_volunteers = 0 }
    every_other_country = {
        limit = {
            has_volunteers_amount_from = {
                tag = FRA
                count > 0
            }
        }
        set_temp_variable = { THIS.vt = 0 }
        while_loop_effect = {
            limit = {
                has_volunteers_amount_from = {
                    tag = FRA
                    count < var:THIS.vt
                }
            }
            add_to_temp_variable = { t = 1 }
        }
        add_to_variable = { FRA.num_of_volunteers = t }
    }
}